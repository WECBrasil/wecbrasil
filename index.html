<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Serviços - WEC Brasil</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .hidden { display: none; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <header class="mb-4 text-center">
      <div class="d-flex justify-content-center align-items-center mb-2">
        <img src="/logo.png" alt="Logo WEC Brasil" height="80" class="me-2">
        <span class="fs-2 fw-bold">WEC Brasil</span>
      </div>
      <h1 class="fs-4">Registro de Serviços</h1>
    </header>

    <!-- Trecho do Login (alterado) -->
<div class="card mb-4" id="loginCard">
  <div class="card-header">Login</div>
  <div class="card-body">
    <form id="formLogin">
      <input type="text" class="form-control mb-2" id="loginUsuario" placeholder="Email" required>
      <div class="input-group mb-2">
        <input type="password" class="form-control" id="loginSenha" placeholder="Senha" required>
      </div>
      <button type="submit" class="btn btn-primary">Entrar</button>
    </form>
    <div class="mt-3">
      <span>Não tem conta?</span>
      <button class="btn btn-link p-0" id="btnMostrarCadastro">Cadastre-se</button>
    </div>
    <!-- Novo botão Esqueceu a senha -->
    <div class="mt-2">
      <button class="btn btn-link p-0" id="btnEsqueceuSenha">Esqueceu a senha?</button>
    </div>
  </div>
</div>

    <!-- Cadastro individual -->
    <div class="card mb-4 hidden" id="cadastroIndividualCard">
      <div class="card-header">Cadastro de Novo Usuário</div>
      <div class="card-body">
        <form id="formCadastroIndividual">
          <input type="text" class="form-control mb-2" id="nomeCadastroIndividual" placeholder="Nome completo" required>
          <input type="email" class="form-control mb-2" id="emailCadastroIndividual" placeholder="Email" required>
          <div class="input-group mb-2">
            <input type="password" class="form-control" id="senhaCadastroIndividual" placeholder="Senha" required>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar</button>
          <button type="button" class="btn btn-link" id="btnVoltarLogin">Voltar ao login</button>
        </form>
      </div>
    </div>

    <!-- Cadastro de usuários (somente para admin) -->
    <div class="card mb-4 hidden" id="cadastroCard">
      <div class="card-header">Cadastro de Usuário</div>
      <div class="card-body">
        <form id="formMissionario">
          <input type="text" class="form-control mb-2" id="nomeMissionario" placeholder="Nome do usuário" required>
          <input type="email" class="form-control mb-2" id="emailMissionario" placeholder="Email" required>
          <input type="password" class="form-control mb-2" id="senhaMissionario" placeholder="Senha" required>
          <select class="form-select mb-2" id="tipoUsuario">
            <option value="comum">Usuário</option>
            <option value="admin">Administrador</option>
          </select>
          <button type="submit" class="btn btn-primary">Cadastrar</button>
        </form>
      </div>
    </div>

    <!-- Alterar senha -->
    <div class="card mb-4 hidden" id="alterarSenhaCard">
      <div class="card-header">Alterar Senha</div>
      <div class="card-body">
        <form id="formAlterarSenha">
          <input type="password" class="form-control mb-2" id="senhaAtual" placeholder="Senha atual" required>
          <input type="password" class="form-control mb-2" id="novaSenha" placeholder="Nova senha" required>
          <button type="submit" class="btn btn-warning">Alterar Senha</button>
        </form>
      </div>
    </div>

    <!-- Registro de uso de serviços -->
    <div class="card mb-4 hidden" id="registroCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Registro de Uso</span>
        <div>
          <button class="btn btn-outline-secondary btn-sm" onclick="mostrarAlterarSenha()">Alterar Senha</button>
          <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
        </div>
      </div>
      <div class="card-body">
        <form id="formUso">
          <div class="mb-2"><strong>Usuário logado:</strong> <span id="usuarioLogado"></span></div>
          <label>Serviço:</label>
          <select id="tipoServico" class="form-select mb-2" required onchange="mostrarCamposServico()">
            <option value="">Selecione</option>
            <option value="lavanderia">Lavanderia</option>
            <option value="carro">Uso do Carro</option>
            <option value="xerox">Cópias e Impressões</option>
            <option value="refeicoes">Refeições</option>
            <option value="hospedagem">Hospedagem</option>
          </select>
          <div id="detalhesServico" class="mb-3"></div>
          <button type="submit" class="btn btn-success">Registrar Uso</button>
        </form>
      </div>
    </div>

    <!-- Listagem de Registros -->
    <div class="card mb-4 hidden" id="listagemRegistrosCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Listagem de Registros</span>
        <small class="text-muted">Meus registros recentes</small>
      </div>
      <div class="card-body">
        <table class="table table-sm table-bordered" id="tabelaRegistros">
          <thead>
            <tr>
              <th style="width:120px">Data</th>
              <th>Tipo</th>
              <th>Detalhes</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody id="listaRegistros">
            <tr>
              <td colspan="4" class="text-center text-muted">Carregando...</td>
            </tr>
          </tbody>
        </table>
        <div class="text-center mt-2">
          <button id="btnVerTodos" class="btn btn-outline-primary btn-sm hidden" type="button">
            Ver todos
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Edição Registro -->
<div class="modal fade" id="modalEditarRegistro" tabindex="-1" aria-labelledby="modalEditarRegistroLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEditarRegistroLabel">Editar Registro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarRegistro">
          <input type="hidden" id="edit-id">
          <div id="camposEdicaoServico"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar</button>
      </div>
    </div>
  </div>
</div>

    <!-- Relatório Geral (apenas para admin ou quem tem liberação) -->
<div class="card hidden" id="relatorioCard">
  <div class="card-header">Relatório Atual</div>
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <div>
      <label for="dataInicial" class="form-label">De:</label>
      <input type="date" class="form-control" id="dataInicial">
    </div>
    <div>
      <label for="dataFinal" class="form-label">Até:</label>
      <input type="date" class="form-control" id="dataFinal">
    </div>
  </div>
  <div class="card-body">
    <button class="btn btn-info" onclick="gerarRelatorio()">Gerar Relatório</button>
    <div class="mt-2">
      <button onclick="baixarRelatorioPDF()" class="btn btn-danger btn-sm me-2">Baixar PDF</button>
      <button onclick="baixarRelatorioExcel()" class="btn btn-success btn-sm">Baixar Excel</button>
    </div>
    <pre id="relatorio" class="mt-3"></pre>
  </div>
</div>

<!-- Relatório de refeições por período -->
<div class="card hidden" id="refeicoesCard">
  <div class="card-header">Relatório de refeições por período</div>
  <div class="card-body">
    <div class="mb-2 d-flex gap-2 flex-wrap">
      <div>
        <label for="dataRefInicio" class="form-label">De:</label>
        <input type="date" class="form-control" id="dataRefInicio">
      </div>
      <div>
        <label for="dataRefFim" class="form-label">Até:</label>
        <input type="date" class="form-control" id="dataRefFim">
      </div>
    </div>
    <button class="btn btn-success mb-2" onclick="gerarRelatorioRefeicoesPeriodo()">Gerar Relatório</button>
    <pre id="relatorioRefeicoesPeriodo" class="bg-light p-2 rounded"></pre>
    <a id="whatsappLinkRefeicoes" class="btn btn-outline-success" href="#" target="_blank" style="display: none;">Compartilhar via WhatsApp</a>
  </div>
</div>

<!-- Gerenciar usuários (apenas admin) -->
<div class="card hidden" id="gerenciarUsuariosCard">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Gerenciar Usuários</span>
    <button class="btn btn-outline-primary btn-sm" onclick="abrirModalUsuarios()">Ver usuários</button>
  </div>
  <div class="card-body">
    <p>Gerencie permissões e exclusão de usuários cadastrados.</p>
  </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      let listaCache = [];
      let registroEditando = null;

      function formatDateISOtoBR(iso) {
        if (!iso) return '';
        const [ano, mes, dia] = iso.split('-');
        return `${dia}/${mes}/${ano}`;
      }

      const { createClient } = window.supabase;
      const supabase = createClient(
        'https://xqwubmknwvvonjzaecmk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxd3VibWtud3Z2b25qemFlY21rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwODY2OTQsImV4cCI6MjA2OTY2MjY5NH0._42N0mZO4NcLPcCG9YMB0_hkMTLF5tCdlPZYagN3vIk'
      );

      async function verificarLogin() {
        const { data: { user }, error } = await supabase.auth.getUser();

        if (!user) {
          document.getElementById('loginCard').classList.remove('hidden');
          document.getElementById('registroCard').classList.add('hidden');
          document.getElementById('listagemRegistrosCard').classList.add('hidden');
          return;
        }

        const { data: perfil, error: perfilError } = await supabase
          .from('usuarios')
          .select('tipo, nome, liberado_relatorio_geral, liberado_relatorio_refeicoes')
          .eq('user_id', user.id)
          .single();

        if (perfilError || !perfil) {
          alert('Erro ao carregar perfil: ' + (perfilError?.message || 'Perfil não encontrado.'));
          await supabase.auth.signOut();
          return location.reload();
        }

        const usuarioLogado = {
          id: user.id,
          email: user.email,
          tipo: perfil.tipo,
          nome: perfil.nome,
          liberado_relatorio_geral: perfil.liberado_relatorio_geral,
          liberado_relatorio_refeicoes: perfil.liberado_relatorio_refeicoes
        };

        localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));
        document.getElementById('usuarioLogado').textContent = usuarioLogado.nome;
        document.getElementById('registroCard')?.classList.remove('hidden');
        document.getElementById('listagemRegistrosCard')?.classList.remove('hidden');
        document.getElementById('loginCard')?.classList.add('hidden');
        document.getElementById('cadastroIndividualCard')?.classList.add('hidden');
        // Mostra áreas de admin/liberados
        if (usuarioLogado.tipo === 'admin') {
        document.getElementById('cadastroCard')?.classList.remove('hidden');
         document.getElementById('gerenciarUsuariosCard')?.classList.remove('hidden');
        }
        if (usuarioLogado.liberado_relatorio_geral || usuarioLogado.tipo === 'admin') {
        document.getElementById('relatorioCard')?.classList.remove('hidden');
        }
        if (usuarioLogado.liberado_relatorio_refeicoes || usuarioLogado.tipo === 'admin') {
        document.getElementById('refeicoesCard')?.classList.remove('hidden');
        }
      }

      document.getElementById('formLogin')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const email = document.getElementById('loginUsuario').value;
        const senha = document.getElementById('loginSenha').value;

        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password: senha
        });

        if (error) {
          alert('Erro ao fazer login: ' + error.message);
          return;
        }

        location.reload();
      });

      document.getElementById('btnMostrarCadastro').addEventListener('click', function () {
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('cadastroIndividualCard').classList.remove('hidden');
      });
      document.getElementById('btnVoltarLogin').addEventListener('click', function () {
        document.getElementById('cadastroIndividualCard').classList.add('hidden');
        document.getElementById('loginCard').classList.remove('hidden');
      });

      document.getElementById('formCadastroIndividual')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const nome = document.getElementById('nomeCadastroIndividual').value.trim();
        const email = document.getElementById('emailCadastroIndividual').value.trim();
        const senha = document.getElementById('senhaCadastroIndividual').value;

        if (!nome || !email || !senha) {
          alert('Preencha todos os campos.');
          return;
        }

        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
          email,
          password: senha,
          options: {
            data: {
              nome,
              tipo: 'comum'
            }
          }
        });

        if (signUpError) {
          alert('Erro ao cadastrar: ' + signUpError.message);
          return;
        }

        const userId = signUpData?.user?.id;

        if (!userId) {
          alert('Usuário criado, mas não foi possível obter o ID.');
          return;
        }

        const { data: existingUser, error: fetchError } = await supabase
          .from('usuarios')
          .select('user_id')
          .eq('user_id', userId)
          .single();

        if (fetchError && fetchError.code !== 'PGRST116') {
          alert('Erro ao verificar usuário existente: ' + fetchError.message);
          return;
        }

        if (!existingUser) {
          const { error: insertError } = await supabase
            .from('usuarios')
            .insert([{ user_id: userId, nome, tipo: 'comum', email }]);

          if (insertError) {
            alert('Erro ao salvar dados do usuário: ' + insertError.message);
            return;
          }
        }

        alert('Cadastro realizado com sucesso. Faça login.');
        this.reset();
        document.getElementById('btnVoltarLogin')?.click();
      });

      async function logout() {
        await supabase.auth.signOut();
        localStorage.removeItem('usuarioLogado');
        location.reload();
      }

      function mostrarAlterarSenha() {
        document.getElementById('alterarSenhaCard').classList.remove('hidden');
      }

      document.getElementById('formAlterarSenha').addEventListener('submit', async function (e) {
        e.preventDefault();

        const senhaAtual = document.getElementById('senhaAtual').value;
        const novaSenha = document.getElementById('novaSenha').value;
        const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
        const { data: authData, error: loginError } = await supabase.auth.signInWithPassword({
          email: usuario.email,
          password: senhaAtual,
        });

        if (loginError) {
          alert('Senha atual incorreta.');
          return;
        }

        const { error: updateError } = await supabase.auth.updateUser({
          password: novaSenha,
        });

        if (updateError) {
          alert('Erro ao alterar senha: ' + updateError.message);
          return;
        }

        alert('Senha alterada com sucesso.');
        document.getElementById('formAlterarSenha').reset();
        document.getElementById('alterarSenhaCard').classList.add('hidden');
      });

      function mostrarCamposServico() {
        const tipo = document.getElementById('tipoServico').value;
        const detalhes = document.getElementById('detalhesServico');
        detalhes.innerHTML = '';

        const hoje = new Date().toISOString().split('T')[0];

        if (tipo === 'lavanderia') {
          detalhes.innerHTML = `
            <label>Data:</label>
            <input type="date" class="form-control mb-2" id="dataLavanderia" value="${hoje}">
            <label>Quantidade de lavagens:</label>
            <input type="number" class="form-control mb-2" id="qtdLavagens" min="0">
            <label>Quantidade de secagens:</label>
            <input type="number" class="form-control mb-2" id="qtdSecagens" min="0">
          `;
        } else if (tipo === 'carro') {
          detalhes.innerHTML = `
            <label>Data:</label>
            <input type="date" class="form-control mb-2" id="dataCarro" value="${hoje}">
            <label>KM Inicial:</label>
            <input type="number" class="form-control mb-2" id="kmInicial" min="0">
            <label>KM Final:</label>
            <input type="number" class="form-control mb-2" id="kmFinal" min="0">
            <label>Uso:</label>
            <select class="form-select mb-2" id="usoCarro" onchange="mostrarCampoDepartamento()">
              <option value="pessoal">Pessoal</option>
              <option value="departamento">Departamento</option>
            </select>
            <div id="campoDepartamento"></div>
            <label>Quantidade de uso da TAG:</label>
            <input type="number" class="form-control mb-2" id="qtdTag" min="0">
          `;
        } else if (tipo === 'xerox') {
          detalhes.innerHTML = `
            <label>Data:</label>
            <input type="date" class="form-control mb-2" id="dataCópias e Impressões" value="${hoje}">
            <label>Tipo de cópia:</label>
    <select class=\"form-select mb-2\" id=\"tipo-copias\">
      <option value=\"pb\">Preto e branco</option>
      <option value=\"color\">Colorida</option>
    </select>
    <label>Quantidade de cópias:</label>
            <input type="number" class="form-control mb-2" id="qtdCópias e Impressões" min="1">
          `;
        } else if (tipo === 'refeicoes') {
          detalhes.innerHTML = `
            <label>Selecionar dias e quantidades:</label>
            <div id="diasRefeicoes" class="mb-2"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="adicionarDiaRefeicao()">Adicionar Dia</button>
          `;
        } else if (tipo === 'hospedagem') {
          detalhes.innerHTML = `
            <label>Data de entrada:</label>
            <input type="date" class="form-control mb-2" id="entrada">
            <label>Data de saída:</label>
            <input type="date" class="form-control mb-2" id="saida" onchange="validarHospedagem()">
            <div id="erroData" class="text-danger"></div>
          `;
        }
      }

      function mostrarCampoDepartamento() {
        const uso = document.getElementById('usoCarro').value;
        const campo = document.getElementById('campoDepartamento');
        if (uso === 'departamento') {
          campo.innerHTML = `
            <label>Departamento:</label>
            <input type="text" class="form-control mb-2" id="departamento">
          `;
        } else {
          campo.innerHTML = '';
        }
      }

      function adicionarDiaRefeicao() {
        const diasContainer = document.getElementById('diasRefeicoes');
        const novoDia = document.createElement('div');
        novoDia.classList.add('mb-2', 'linha-dia');
        novoDia.innerHTML = `
          <div class="d-flex align-items-center">
            <input type="date" class="form-control me-2 data-refeicao" required>
            <input type="number" class="form-control qtd-refeicao" placeholder="Quantidade" min="1" required>
            <button type="button" class="btn btn-danger btn-sm ms-2" onclick="this.parentElement.parentElement.remove()">X</button>
          </div>
        `;
        diasContainer.appendChild(novoDia);
      }

      function validarHospedagem() {
        const entrada = document.getElementById('entrada').value;
        const saida = document.getElementById('saida').value;
        const erro = document.getElementById('erroData');
        if (entrada && saida && saida < entrada) {
          erro.textContent = 'A data de saída não pode ser anterior à entrada.';
        } else {
          erro.textContent = '';
        }
      }

      async function prepararRegistro() {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          alert('Usuário não autenticado');
          return;
        }

        const tipo = document.getElementById('tipoServico').value;
        const hoje = new Date().toISOString().split('T')[0];

        const registro = {
          user_id: user.id,
          tipo,
          data: hoje
        };

        if (tipo === 'lavanderia') {
          const lavagens = document.getElementById('qtdLavagens').value;
          const secagens = document.getElementById('qtdSecagens').value;
          const data = document.getElementById('dataLavanderia').value;

          if (!lavagens || !secagens) return alert('Preencha a quantidade de lavagens e secagens.');
          if (!data) return alert('Informe a data.');
          
          registro.qtdlavagens = parseInt(lavagens);
          registro.qtdsecagens = parseInt(secagens);
          registro.data = data;

        } else if (tipo === 'carro') {
          const kmInicial = document.getElementById('kmInicial').value;
          const kmFinal = document.getElementById('kmFinal').value;
          const qtdTag = document.getElementById('qtdTag').value;
          const uso = document.getElementById('usoCarro').value;
          const data = document.getElementById('dataCarro').value;

          if (!kmInicial || !kmFinal || isNaN(kmInicial) || isNaN(kmFinal)) {
            return alert('Informe os km inicial e final.');
          }
          if (!data) return alert('Informe a data.');

          registro.kminicial = parseInt(kmInicial);
          registro.kmfinal = parseInt(kmFinal);
          registro.qtdtag = parseInt(qtdTag) || 0;
          registro.uso = uso;
          registro.data = data;

          if (uso === 'departamento') {
            const departamento = document.getElementById('departamento').value;
            if (!departamento) return alert('Informe o nome do departamento.');
            registro.departamento = departamento;
          }

        } else if (tipo === 'xerox') {
          const qtd = document.getElementById('qtdCópias e Impressões').value;
          const data = document.getElementById('dataCópias e Impressões').value;

          if (!qtd) return alert('Informe a quantidade de cópias.');
          if (!data) return alert('Informe a data.');

          registro.qtd = parseInt(qtd);
  registro.tipo_copias = document.getElementById('tipo-copias').value;
          registro.data = data;

        } else if (tipo === 'refeicoes') {
          const dias = [];
          let erro = false;

          document.querySelectorAll('.linha-dia').forEach(el => {
            const data = el.querySelector('.data-refeicao').value;
            const qtd = el.querySelector('.qtd-refeicao').value;
            if (!data || !qtd) erro = true;
            dias.push({ data, qtd: parseInt(qtd) });
          });

          if (erro || dias.length === 0) return alert('Preencha todos os dias e quantidades de refeições.');
          registro.dias = dias;

        } else if (tipo === 'hospedagem') {
          const entrada = document.getElementById('entrada').value;
          const saida = document.getElementById('saida').value;

          if (!entrada || !saida) return alert('Preencha as datas de entrada e saída.');
          if (saida < entrada) return alert('A data de saída não pode ser anterior à entrada.');

          registro.entrada = entrada;
          registro.saida = saida;
        }

        const { error } = await supabase.from('registros').insert([registro]);
        if (error) {
          console.error('Erro ao salvar registro:', error);
          alert('Erro ao salvar registro. Verifique os dados e tente novamente.');
        } else {
          alert('Registro salvo com sucesso!');
          document.getElementById('formUso').reset();
          document.getElementById('tipoServico').value = '';
          mostrarCamposServico();
          const campoDepartamento = document.getElementById('campoDepartamento');
          if (campoDepartamento) campoDepartamento.innerHTML = '';
          carregarListaRegistros();
        }
      }

      document.getElementById('formUso').addEventListener('submit', function (e) {
        e.preventDefault();
        prepararRegistro();
      });

      function gerarDescricaoDetalhada(reg) {
        if (!reg) return '';

        const tipoNormalizado = (reg.tipo || '').toLowerCase().trim();

        switch (tipoNormalizado) {
          case 'lavanderia': {
            const lavagens = Number(reg.qtdlavagens) || 0;
            const secagens = Number(reg.qtdsecagens) || 0;
            let res = [];
            if (lavagens) res.push(`Lavagens: ${lavagens}`);
            if (secagens) res.push(`Secagens: ${secagens}`);
            return res.join(' · ') || '-';
          }
          case 'carro': {
            const kmIni = parseInt(reg.kminicial) || 0;
            const kmFim = parseInt(reg.kmfinal) || 0;
            const km = kmIni && kmFim ? kmFim - kmIni : 0;
            let res = [];
            if (kmIni && kmFim) res.push(`KM: ${kmIni} → ${kmFim} (${km} km)`);
            if (reg.uso) res.push(`Uso: ${reg.uso}`);
            if (reg.departamento) res.push(`Dept: ${reg.departamento}`);
            if (reg.motorista) res.push(`Motorista: ${reg.motorista}`);
            if (reg.qtdtag) res.push(`TAGs: ${reg.qtdtag}`);
            return res.join(' · ') || '-';
          }
          case 'xerox': {
            if (reg.qtd) return `Cópias: ${reg.qtd}`;
            return '-';
          }
          case 'refeicoes': {
            if (!Array.isArray(reg.dias) || reg.dias.length === 0) return 'Refeições (detalhes não disponíveis)';
            return reg.dias
              .filter(d => d.qtd)
              .map(d => `${formatDateISOtoBR(d.data)} x${d.qtd}`)
              .join(' · ') || '-';
          }
          case 'hospedagem': {
            const entrada = reg.entrada ? formatDateISOtoBR(reg.entrada) : null;
            const saida = reg.saida ? formatDateISOtoBR(reg.saida) : null;
            let res = [];
            if (entrada) res.push(`Entrada: ${entrada}`);
            if (saida) res.push(`Saída: ${saida}`);
            return res.join(' · ') || '-';
          }
          default:
            return reg.descricao || '-';
        }
      }

      async function carregarListaRegistros(limite = 5, verTodos = false) {
        try {
          const { data: userData, error: userError } = await supabase.auth.getUser();
          if (userError) throw userError;
          const user = userData?.user || null;

          let query = supabase
            .from('registros')
            .select('*')
            .order('data', { ascending: false });

          if (!verTodos && user) query = query.eq('user_id', user.id);
          if (limite != null && Number(limite) > 0) query = query.limit(Number(limite));

          const { data, error } = await query;
          if (error) throw error;

          listaCache = data || [];

          const tbody = document.getElementById('listaRegistros');
          if (!listaCache.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Nenhum registro encontrado.</td></tr>`;
            document.getElementById('btnVerTodos')?.classList.toggle('hidden', !(limite != null && Number(limite) > 0));
            return;
          }

          const rows = listaCache.map(reg => {
            const dataExib = reg.data
              ? new Date(String(reg.data) + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC' })
              : 'Sem data';
            const detalhes = gerarDescricaoDetalhada(reg).replace(/</g, '&lt;');
            return `
              <tr>
                <td>${dataExib}</td>
                <td>${reg.tipo || ''}</td>
                <td>${detalhes}</td>
                <td>
                  <button class="btn btn-sm btn-warning me-1" onclick="editarRegistro('${String(reg.id)}')">Editar</button>
                  <button class="btn btn-sm btn-danger" onclick="excluirRegistroSupabase('${String(reg.id)}')">Excluir</button>
                </td>
              </tr>
            `;
          }).join('');

          tbody.innerHTML = rows;

          document.getElementById('btnVerTodos')?.classList.toggle('hidden', !(limite != null && Number(limite) > 0));
        } catch (err) {
          console.error('Erro ao carregar registros:', err);
          document.getElementById('listaRegistros').innerHTML =
            `<tr><td colspan="4" class="text-center text-danger">Erro ao carregar registros: ${err.message || err}</td></tr>`;
        }
      }

      document.getElementById('btnVerTodos').addEventListener('click', () => {
        carregarListaRegistros(null, true);
      });

      async function excluirRegistroSupabase(id) {
        if (!confirm('Tem certeza que deseja excluir este registro?')) return;

        const { error } = await supabase
          .from('registros')
          .delete()
          .eq('id', id);

        if (error) {
          console.error('Erro ao excluir registro:', error);
          alert('Erro ao excluir registro: ' + (error.message || error));
        } else {
          alert('Registro excluído com sucesso.');
          carregarListaRegistros();
        }
      }

      async function editarRegistro(id) {
  const registro = listaCache.find(r => String(r.id) === String(id));
  if (!registro) {
    alert('Registro não encontrado.');
    return;
  }
  registroEditando = registro;
  document.getElementById('edit-id').value = registro.id;

  // Monta os campos conforme o tipo
  const container = document.getElementById('camposEdicaoServico');
  const tipo = registro.tipo;

  let html = `<label class="form-label">Tipo</label>
    <input type="text" class="form-control mb-2" id="edit-tipo" value="${tipo}" disabled>`;

  switch(tipo) {
    case 'lavanderia':
      html += `
        <label>Data:</label>
        <input type="date" class="form-control mb-2" id="edit-data" value="${registro.data || ''}" required>
        <label>Quantidade de lavagens:</label>
        <input type="number" class="form-control mb-2" id="edit-qtdLavagens" value="${registro.qtdlavagens || 0}" min="0">
        <label>Quantidade de secagens:</label>
        <input type="number" class="form-control mb-2" id="edit-qtdSecagens" value="${registro.qtdsecagens || 0}" min="0">
      `;
      break;
    case 'carro':
      html += `
        <label>Data:</label>
        <input type="date" class="form-control mb-2" id="edit-data" value="${registro.data || ''}" required>
        <label>KM Inicial:</label>
        <input type="number" class="form-control mb-2" id="edit-kmInicial" value="${registro.kminicial || 0}" min="0">
        <label>KM Final:</label>
        <input type="number" class="form-control mb-2" id="edit-kmFinal" value="${registro.kmfinal || 0}" min="0">
        <label>Uso:</label>
        <select class="form-select mb-2" id="edit-usoCarro">
          <option value="pessoal" ${registro.uso === 'pessoal' ? 'selected' : ''}>Pessoal</option>
          <option value="departamento" ${registro.uso === 'departamento' ? 'selected' : ''}>Departamento</option>
        </select>
        <div id="edit-campoDepartamento" class="mb-2">
          ${registro.uso === 'departamento' ? `
            <label>Departamento:</label>
            <input type="text" class="form-control mb-2" id="edit-departamento" value="${registro.departamento || ''}">
          ` : ''}
        </div>
        <label>Quantidade de uso da TAG:</label>
        <input type="number" class="form-control mb-2" id="edit-qtdTag" value="${registro.qtdtag || 0}" min="0">
      `;
      break;
    case 'xerox':
      html += `
        <label>Data:</label>
        <input type="date" class="form-control mb-2" id="edit-data" value="${registro.data || ''}" required>
        <label>Quantidade de cópias:</label>
        <input type="number" class="form-control mb-2" id="edit-qtdCópias e Impressões" value="${registro.qtd || 0}" min="1">
      `;
      break;
    case 'refeicoes':
      html += `<div id="edit-refeicoesDias"></div>
      <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="adicionarDiaRefeicaoEdicao()">Adicionar Dia</button>`;
      break;
    case 'hospedagem':
      html += `
        <label>Data de entrada:</label>
        <input type="date" class="form-control mb-2" id="edit-entrada" value="${registro.entrada || ''}">
        <label>Data de saída:</label>
        <input type="date" class="form-control mb-2" id="edit-saida" value="${registro.saida || ''}">
        <div id="edit-erroData" class="text-danger"></div>
      `;
      break;
    default:
      html += `<div class="alert alert-warning">Tipo de serviço desconhecido para edição.</div>`;
  }
  container.innerHTML = html;

  // Especial para refeições: renderize os dias existentes
  if (tipo === 'refeicoes' && Array.isArray(registro.dias)) {
    const refeicoesContainer = document.getElementById('edit-refeicoesDias');
    registro.dias.forEach(dia => {
      const linha = document.createElement('div');
      linha.classList.add('mb-2', 'edit-linha-dia');
      linha.innerHTML = `
        <div class="d-flex align-items-center">
          <input type="date" class="form-control me-2 edit-data-refeicao" value="${dia.data}" required>
          <input type="number" class="form-control edit-qtd-refeicao" placeholder="Quantidade" min="1" value="${dia.qtd}" required>
          <button type="button" class="btn btn-danger btn-sm ms-2" onclick="this.parentElement.parentElement.remove()">X</button>
        </div>
      `;
      refeicoesContainer.appendChild(linha);
    });
  }

  // Departamento dinâmico: atualize ao mudar o uso
  if (tipo === 'carro') {
    document.getElementById('edit-usoCarro').addEventListener('change', function() {
      const campo = document.getElementById('edit-campoDepartamento');
      if (this.value === 'departamento') {
        campo.innerHTML = `
          <label>Departamento:</label>
          <input type="text" class="form-control mb-2" id="edit-departamento" value="${registro.departamento || ''}">
        `;
      } else {
        campo.innerHTML = '';
      }
    });
  }

  // Mostra o modal
  const modalEl = document.getElementById('modalEditarRegistro');
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
}

// Adicionar novo dia de refeições no modo edição
function adicionarDiaRefeicaoEdicao() {
  const diasContainer = document.getElementById('edit-refeicoesDias');
  const novoDia = document.createElement('div');
  novoDia.classList.add('mb-2', 'edit-linha-dia');
  novoDia.innerHTML = `
    <div class="d-flex align-items-center">
      <input type="date" class="form-control me-2 edit-data-refeicao" required>
      <input type="number" class="form-control edit-qtd-refeicao" placeholder="Quantidade" min="1" required>
      <button type="button" class="btn btn-danger btn-sm ms-2" onclick="this.parentElement.parentElement.remove()">X</button>
    </div>
  `;
  diasContainer.appendChild(novoDia);
}

      async function salvarEdicao() {
  const id = document.getElementById('edit-id').value;
  const tipo = registroEditando.tipo; // O tipo não muda!
  let payload = {};
  let valid = true;

  switch(tipo) {
    case 'lavanderia':
      payload = {
        data: document.getElementById('edit-data').value,
        qtdlavagens: Number(document.getElementById('edit-qtdLavagens').value),
        qtdsecagens: Number(document.getElementById('edit-qtdSecagens').value)
      };
      if (!payload.data) valid = false;
      break;
    case 'carro':
      payload = {
        data: document.getElementById('edit-data').value,
        kminicial: Number(document.getElementById('edit-kmInicial').value),
        kmfinal: Number(document.getElementById('edit-kmFinal').value),
        uso: document.getElementById('edit-usoCarro').value,
        qtdtag: Number(document.getElementById('edit-qtdTag').value)
      };
      if (payload.uso === 'departamento') {
        payload.departamento = document.getElementById('edit-departamento').value;
      }
      if (!payload.data) valid = false;
      break;
    case 'xerox':
      payload = {
        data: document.getElementById('edit-data').value,
        qtd: Number(document.getElementById('edit-qtdCópias e Impressões').value)
      };
      if (!payload.data) valid = false;
      break;
    case 'refeicoes':
      const dias = [];
      document.querySelectorAll('.edit-linha-dia').forEach(el => {
        const data = el.querySelector('.edit-data-refeicao').value;
        const qtd = el.querySelector('.edit-qtd-refeicao').value;
        if (data && qtd) dias.push({ data, qtd: Number(qtd) });
      });
      payload = { dias };
      if (dias.length === 0) valid = false;
      break;
    case 'hospedagem':
      payload = {
        entrada: document.getElementById('edit-entrada').value,
        saida: document.getElementById('edit-saida').value
      };
      if (!payload.entrada || !payload.saida) valid = false;
      break;
    default:
      valid = false;
  }

  if (!valid) {
    alert('Preencha todos os campos obrigatórios.');
    return;
  }

  // Atualize via Supabase
  const { error } = await supabase
    .from('registros')
    .update(payload)
    .eq('id', id);

  if (error) {
    alert('Erro ao atualizar: ' + error.message);
    return;
  }

  bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro')).hide();
  alert('Registro atualizado com sucesso!');
  carregarListaRegistros();
};

      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
          verificarLogin();
          carregarListaRegistros();
        } else if (event === 'SIGNED_OUT') {
          document.getElementById('listaRegistros').innerHTML =
            `<tr><td colspan="4" class="text-center text-muted">Faça login para ver seus registros.</td></tr>`;
        }
      });

async function gerarRelatorio() {
  const relatorioDiv = document.getElementById('relatorio');
  relatorioDiv.innerHTML = '';

  // Agrupa registros por usuário
  const acc = {};
  registros.forEach(r => {
    const user = r.user_id || "Desconhecido";
    if (!acc[user]) acc[user] = [];
    acc[user].push(r);
  });

  // Gera relatório agrupado
  Object.keys(acc).forEach(user => {
    relatorioDiv.innerHTML += `<h4>Usuário: ${user}</h4>`;

    acc[user].forEach(r => {
      if (r.tipo === 'xerox') {
        relatorioDiv.innerHTML += `
          <div>
            <strong>Serviço:</strong> ${r.tipo}<br>
            <strong>Data:</strong> ${r.data}<br>
            <strong>Tipo de cópia:</strong> ${r.tipo_copias || '-'}<br>
            <strong>Quantidade:</strong> ${r.qtd}
          </div><hr>`;
      } else {
        relatorioDiv.innerHTML += `
          <div>
            <strong>Serviço:</strong> ${r.tipo}<br>
            <strong>Data:</strong> ${r.data}<br>
            <strong>Quantidade:</strong> ${r.qtd || '-'}
          </div><hr>`;
      }
    });
  });
}
async function excluirUsuario(user_id) {
  if (!confirm('Tem certeza que deseja excluir este usuário?')) return;
  const {
    data: { session },
    error: sessionError
  } = await supabase.auth.getSession();
  if (sessionError || !session) {
    alert('Usuário não autenticado.');
    return;
  }
  const res = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/excluir-usuario-ts', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify({ user_id }),
  });
  if (!res.ok) {
    const err = await res.text();
    alert('Erro ao excluir usuário: ' + err);
    return;
  }
  alert('Usuário excluído com sucesso.');
  carregarListaUsuarios();
}
async function alterarPermissao(user_id, permissao, valor) {
  try {
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (sessionError || !session) {
      alert('Usuário não autenticado.');
      return;
    }
    const token = session.access_token;
    const response = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/alterar-permissao-usuario', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ user_id, permissao, valor: Boolean(valor) })
    });
    if (!response.ok) {
      const erroTexto = await response.text();
      alert('Erro ao alterar permissão: ' + erroTexto);
      return;
    }
    const result = await response.json();
    if (result.success) {
      alert('Permissão alterada com sucesso!');
      carregarListaUsuarios();
    } else {
      alert('Falha ao alterar permissão');
    }
  } catch (error) {
    alert('Erro na comunicação com o servidor: ' + error.message);
  }
}
document.getElementById('formMissionario').addEventListener('submit', async function (e) {
  e.preventDefault();
  const nome = document.getElementById('nomeMissionario').value.trim();
  const email = document.getElementById('emailMissionario').value.trim();
  const senha = document.getElementById('senhaMissionario').value;
  const tipo = document.getElementById('tipoUsuario').value;
  if (!nome || !email || !senha || !tipo) {
    alert('Preencha todos os campos.');
    return;
  }
  try {
    const { data: sessionData, error } = await supabase.auth.getSession();
    const token = sessionData?.session?.access_token;
    if (!token) {
      alert('Usuário não autenticado.');
      return;
    }
    const response = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/criar-usuario-ts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ nome, email, senha, tipo })
    });
    if (!response.ok) {
      const errorText = await response.text();
      alert('Erro ao cadastrar: ' + errorText);
      return;
    }
    alert('Usuário cadastrado com sucesso!');
    document.getElementById('formMissionario').reset();
    if (typeof carregarListaUsuarios === 'function') {
      carregarListaUsuarios();
    }
  } catch (error) {
    alert('Erro ao cadastrar: ' + error.message);
  }
});

    async function abrirModalUsuarios() {
  const lista = document.getElementById('listaUsuariosModal');
  lista.innerHTML = '<li class="list-group-item text-center text-muted">Carregando...</li>';
  const { data, error } = await supabase.auth.getSession();
  if (error || !data.session) {
    lista.innerHTML = '<li class="list-group-item text-danger">Usuário não autenticado.</li>';
    return;
  }
  const token = data.session.access_token;
  const usuarioAtual = data.session.user;
  try {
    const res = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/listar-usuarios-seguro', {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) {
      const err = await res.text();
      lista.innerHTML = `<li class="list-group-item text-danger">Erro: ${err}</li>`;
      return;
    }
    const dados = await res.json();
    const usuarios = dados.usuarios || [];
    if (usuarios.length === 0) {
      lista.innerHTML = '<li class="list-group-item text-center text-muted">Nenhum usuário encontrado.</li>';
      return;
    }
    lista.innerHTML = '';
    usuarios.forEach((u) => {
      if (u.user_id === usuarioAtual.id) return;
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex flex-column align-items-start';
      const nomeExibicao = u.nome || '(sem nome)';
      const tipo = u.tipo || 'desconhecido';
      li.innerHTML = `
        <div class="d-flex justify-content-between w-100">
          <div>
            <strong>${nomeExibicao}</strong><br>
            <small>${u.email || u.user_id}</small><br>
            <small class="text-muted">${tipo}</small>
          </div>
          <div class="d-flex flex-column align-items-end gap-1">
            ${tipo !== 'admin' ? `
              <button class="btn btn-sm ${u.liberado_relatorio_geral ? 'btn-success' : 'btn-secondary'}" 
                      onclick="alterarPermissao('${u.user_id}', 'liberado_relatorio_geral', ${!u.liberado_relatorio_geral})">
                Relatório Geral
              </button>
              <button class="btn btn-sm ${u.liberado_relatorio_refeicoes ? 'btn-success' : 'btn-secondary'}" 
                      onclick="alterarPermissao('${u.user_id}', 'liberado_relatorio_refeicoes', ${!u.liberado_relatorio_refeicoes})">
                Relatório Refeições
              </button>
            ` : ''}
            <button class="btn btn-sm btn-danger" onclick="excluirUsuario('${u.user_id}')">Excluir</button>
          </div>
        </div>
      `;
      lista.appendChild(li);
    });
  } catch (error) {
    lista.innerHTML = `<li class="list-group-item text-danger">Erro: ${error.message}</li>`;
  }
  // Abre o modal
  const modalEl = document.getElementById('modalListaUsuarios');
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
    }

      // Fluxo de recuperação de senha
document.getElementById('btnEsqueceuSenha')?.addEventListener('click', async function () {
  const email = prompt('Digite o seu email para redefinir a senha:');
  if (!email) return;

  const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + '/reset.html' // página de reset
  });

  if (error) {
    alert('Erro ao enviar email de redefinição: ' + error.message);
    return;
  }

  alert('Se este email estiver cadastrado, você receberá instruções para redefinir sua senha.');
});
    </script>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Modal Lista de Usuários -->
<div class="modal fade" id="modalListaUsuarios" tabindex="-1" aria-labelledby="modalListaUsuariosLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalListaUsuariosLabel">Usuários Cadastrados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <ul id="listaUsuariosModal" class="list-group"></ul>
      </div>
    </div>
  </div>
</div>
</body>
</html>
